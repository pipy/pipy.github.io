<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>機関空売り残高 viewer</title>
  <link rel="canonical" href="https://pipy.github.io/">
  <meta property="og:url" content="https://pipy.github.io/">
  <meta name="description" content="JPX翌日報告対応の空売り残高ビューア。銘柄ごとの前日比推移を素早くチェック。">
  <meta name="robots" content="index,follow">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7894074562070938"
     crossorigin="anonymous"></script>
  <style>
    :root{ --bg:#f8fafc;--card:#fff;--muted:#64748b;--line:#cbd5e1;--accent:#2563eb; --pos:#dc2626;--neg:#16a34a; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Meiryo",sans-serif;margin:0;padding:24px;background:var(--bg);color:#0f172a}
    h1{font-size:1.35rem;margin:0 0 12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .container{max-width:1200px;margin:0 auto}

    /* 1カラムのみ */
    .layout{display:grid;grid-template-columns:1fr;gap:16px}

    .searchWrap{position:relative;max-width:520px;flex:1}
    #searchBox{padding:10px 12px;width:100%;border:1px solid var(--line);border-radius:8px;background:#fff}
    #suggestList{position:absolute;top:100%;left:0;right:0;z-index:10;background:#fff;border:1px solid var(--line);border-top:none;border-radius:0 0 8px 8px;max-height:300px;overflow:auto;display:none}
    .suggestItem{padding:8px 12px;cursor:pointer}
    .suggestItem[aria-selected="true"], .suggestItem:hover{background:#e2e8f0}

    table{width:100%;border-collapse:collapse;margin-top:12px;background:var(--card);border-radius:12px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
    thead th{background:#e2e8f0}
    tfoot th, tfoot td{background:#f1f5f9;font-weight:600}
    .pos{text-align:right;white-space:nowrap}
    .change.pos{color:var(--pos)} .change.neg{color:var(--neg)}
    .status{font-size:.75rem;display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:#111}
    .status.lost{background:#f3f4f6}
    .status.carry{background:#ecfeff;border-color:#bae6fd;color:#0369a1}
    .status.adv{background:#fef3c7;border-color:#fde68a;color:#92400e}
    .muted{color:var(--muted)}
    #noResult{color:var(--muted);margin-top:8px}
    .meta{font-size:.85rem;color:#64748b}
    .panel{margin-top:12px;padding:8px 12px;border:1px solid var(--line);border-radius:8px;background:#fff}

    /* a11y helpers */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div class="container">
    <div class="row" style="justify-content:space-between">
      <h1 id="pageTitle" aria-live="polite">機関空売り残高 viewer</h1>
      <div id="metaInfo" class="meta"></div>
    </div>

    <div class="layout">
      <main>
        <div class="row" style="margin-bottom:8px">
          <div class="searchWrap">
            <label for="searchBox" class="sr-only">銘柄検索</label>
            <input id="searchBox" value="" placeholder="証券コード・社名で検索…" autocomplete="off" aria-autocomplete="list" aria-controls="suggestList" aria-expanded="false" />
            <div id="suggestList" role="listbox"></div>
          </div>
        </div>

        <div id="noResult" style="display:none;">検索結果が見つかりませんでした。</div>

        <table id="shortTable" style="display:none;">
          <thead>
            <tr>
              <th style="min-width:160px">空売り機関名</th>
              <th class="pos">前営業日残高(株)</th>
              <th class="pos">残高(株)</th>
              <th class="pos">前営業日比(株)</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <th>合計</th>
              <th class="pos" id="totalPrev"></th>
              <th class="pos" id="totalPos"></th>
              <th class="pos" id="totalChange"></th>
            </tr>
          </tfoot>
        </table>

        <div id="datesPanel" class="panel" style="display:none"></div>

        <div class="muted" style="margin-top:12px">
          ※ 当サイトはデータ提供サイトであり、特定銘柄の売買推奨を行うものではありません。データの正確性・完全性は保証されません。<br>
          当サイトに掲載されている情報に起因して生じた損害やトラブルについて、当方は一切の責任を負いかねます。<br>
          ご利用にあたっては内容をご理解のうえ、各自のご判断と責任にてお願いいたします。<br>
          出典：JPX「空売りの残高に関する情報」等（公式公開後の数値を加工・可視化しています）<br>
          問い合わせ先：runyora669@meruado.uk<br>
          © 2025 機関空売り残高 viewer
        </div>
      </main>
    </div>
  </div>

<script>
/* ========= ユーティリティ ========= */
const esc = (s='') => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
const fmt = n => new Intl.NumberFormat('ja-JP').format(Number(n)||0);
const kataToHira = s => s.replace(/[ァ-ヶ]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0x60));
const zenkakuToHankaku = s => s.replace(/[！-～]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0xFEE0));
const norm = s => kataToHira(zenkakuToHankaku(String(s||'')).toLowerCase());
const by = sel => document.querySelector(sel);

/* ========= DOM ========= */
const metaInfo = by('#metaInfo');
const suggestions = by('#suggestList');
const searchBox = by('#searchBox');
const table = by('#shortTable');
const tbody = table.querySelector('tbody');
const totalPrev = by('#totalPrev');
const totalPos = by('#totalPos');
const totalChange = by('#totalChange');
const noResult = by('#noResult');
const datesPanel = by('#datesPanel');
const pageTitle = by('#pageTitle');

/* ========= データ ========= */
let STOCKS = [];

/* ========= 検索状態の保持（URL & localStorage） ========= */
const LS_KEY = 'shorts_last_query_code';

function getQueryCode(){
  const u = new URL(location.href);
  return (u.searchParams.get('q')||'').trim();
}
function setQueryCode(code, mode='push'){
  const u = new URL(location.href);
  if(code) u.searchParams.set('q', code); else u.searchParams.delete('q');
  const state = { q: code || '' };
  if(mode === 'push') history.pushState(state, '', u.toString());
  else history.replaceState(state, '', u.toString());
}
function saveLastCode(code){
  if(code) localStorage.setItem(LS_KEY, code); else localStorage.removeItem(LS_KEY);
}
function restoreLastCode(){
  return localStorage.getItem(LS_KEY)||'';
}

/* ========= JSON ロード ========= */
async function loadJSON(){
  const candidates = ['latest_short_update.json','latest_shorts.json','latest_short.json'];
  let raw=null;
  for(const p of candidates){
    try{
      const res = await fetch(`${p}?ts=${Date.now()}`, {cache:'no-store'});
      if(res.ok){ raw = await res.json(); break; }
    }catch(_e){}
  }
  if(!raw) throw new Error('データ取得に失敗しました');

  const arr = Array.isArray(raw) ? raw : (Array.isArray(raw.items) ? raw.items : []);
  STOCKS = arr.map(s => ({
    code: String(s.code||''),
    name: s.name||'',
    reading: s.reading || s.name || '',
    shorts: Array.isArray(s.shorts)? s.shorts: [],
    dates: Array.isArray(s.dates)? s.dates: [],
    base_date: s.base_date || ''
  }));
  metaInfo.textContent = `銘柄: ${fmt(STOCKS.length)}件 `;
}

/* ========= サジェスト ========= */
function showSuggestions(list){
  if(list.length===0){
    suggestions.style.display='none';
    searchBox.setAttribute('aria-expanded','false');
    return;
  }
  suggestions.innerHTML = list.slice(0,30).map(s =>
    `<div class="suggestItem" role="option" data-code="${esc(s.code)}">${esc(s.code)}　${esc(s.name)}</div>`
  ).join('');
  suggestions.style.display='block';
  searchBox.setAttribute('aria-expanded','true');
}

function updateSuggestions(term){
  term = term.trim();
  if(term.length < 1){
    suggestions.style.display='none';
    searchBox.setAttribute('aria-expanded','false');
    return;
  }
  const q = norm(term);
  const matches = STOCKS.filter(s => s.code.startsWith(q) || norm(s.name).includes(q) || norm(s.reading).startsWith(q));
  showSuggestions(matches);
}

function findStock(code){ return STOCKS.find(s=>s.code===code); }

/* ========= 日付パネル ========= */
function renderDatesPanel(stock){
  if(!stock?.dates?.length){ datesPanel.style.display='none'; datesPanel.innerHTML=''; return; }
  datesPanel.style.display='block';

  const base = getBaseDate(stock);
  const note = base ? `` : '';
  datesPanel.innerHTML = `<div class="muted">最新データ内訳 ${note}</div>`;

  stock.dates.forEach(d=>{
    const adv = !!d.is_advanced;
    const header = `<strong>${esc(d.date||'—')}</strong> <span class="muted">　合計: ${fmt(d.total)}${adv?'（集計外）':''}</span>`;
    const items = (d.items||[]).map(x=>`<li>${esc(x.name)} ${fmt(x.position)}</li>`).join('');
    datesPanel.insertAdjacentHTML('beforeend',
      `<div style="margin-top:6px;padding:8px 12px;border:1px solid #cbd5e1;border-radius:8px;background:#fff">
        <div>${header}</div>
        <ul style="margin:6px 0 0; padding-left:18px">${items}</ul>
      </div>`
    );
  });
}

/* ========= 見出し/base日付 ========= */
function getBaseDate(stock){
  if(stock.base_date) return stock.base_date;
  const ds = (stock.dates||[]).map(x=>x.date).filter(Boolean).sort();
  return ds.length ? ds[ds.length-1] : '';
}

function updatePageTitleFor(stock){
  const base = getBaseDate(stock) || '—';
  pageTitle.textContent = `${base}の空売り残高`;
  document.title = `${stock.code} ${stock.name} | ${pageTitle.textContent}`;
}

/* ========= テーブル描画 ========= */
function renderStock(stock){
  if(!stock){ table.style.display='none'; noResult.style.display='block'; datesPanel.style.display='none'; return; }
  noResult.style.display='none'; table.style.display='table'; tbody.innerHTML='';

  updatePageTitleFor(stock);

  const showLost = true;     // 報告義務消失した日は表示する
  const showAdv  = false;    // 翌日報告は表示しない
  const dimCarry = false;    // 据え置きを薄くしない

  const rows = (stock.shorts||[])
    .filter(d => showLost || d.status!=="reporting_lost")
    .filter(d => showAdv ? true : !d.is_advanced)
    .map(d => ({
      name: (d.name && d.name!=="nan") ? d.name : '不明（要確認）',
      status: d.status||'normal',
      isAdv: !!d.is_advanced,
      pos: Number(d.position)||0,
      ch: Number(d.change)||0,
      prev: (Number(d.position)||0) - (Number(d.change)||0),
      calc_date: d.calc_date || ''
    }));

  let sumPrev=0, sumPos=0, sumCh=0;
  for(const r of rows){
    const delta = (r.ch>=0?'+':'') + fmt(r.ch);
    const changeCls = r.ch>=0 ? 'pos' : 'neg';
    const faded = (dimCarry && r.status==='carried_forward') ? 'opacity:.6' : '';
    tbody.insertAdjacentHTML('beforeend',
      `<tr style="${faded}">
        <td>${esc(r.name)} ${statusBadge(r.status, r.isAdv)} ${r.calc_date?`<span class="muted">（${esc(r.calc_date)}）</span>`:''}</td>
        <td class="pos">${fmt(r.prev)}</td>
        <td class="pos">${fmt(r.pos)}</td>
        <td class="pos change ${changeCls}">${delta}</td>
      </tr>`
    );
    sumPrev+=r.prev; sumPos+=r.pos; sumCh+=r.ch;
  }

  totalPrev.textContent = fmt(sumPrev);
  totalPos.textContent = fmt(sumPos);
  totalChange.textContent = `${sumCh>=0?'+':''}${fmt(sumCh)}`;

  renderDatesPanel(stock);
}

/* バッジ */
function statusBadge(status, isAdv){
  if(isAdv) return '';
  if(status==='reporting_lost') return '<span class="status lost">報告義務消失</span>';
  if(status==='carried_forward') return '<span class="status carry">据え置き</span>';
  return '';
}

/* ========= 検索選択の適用（URL/LS更新を一括） ========= */
function applySelection(stock){
  if(!stock){ return; }
  setQueryCode(stock.code, 'push');
  saveLastCode(stock.code);
  searchBox.value = `${stock.code} ${stock.name}`.trim();
  renderStock(stock);
}

/* ========= ホーム状態（未選択）に戻す ========= */
function clearSelection({push=false}={}){
  setQueryCode('', push ? 'push' : 'replace');
  searchBox.value = '';
  table.style.display='none';
  datesPanel.style.display='none';
  noResult.style.display='none';
  pageTitle.textContent = '空売り残高';
  document.title = '機関空売り残高 viewer';
}

/* ========= イベント（IME対応版） ========= */
let isComposing = false;

searchBox.addEventListener('compositionstart', () => { isComposing = true; });
searchBox.addEventListener('compositionend', (e) => {
  isComposing = false;
  updateSuggestions(e.target.value);
});

searchBox.addEventListener('input', (e) => {
  if (isComposing || e.isComposing) return;
  updateSuggestions(e.target.value);
});

searchBox.addEventListener('keydown', (e) => {
  if (isComposing || e.isComposing || e.keyCode === 229) return;

  if (e.key === 'Enter') {
    e.preventDefault();

    if (!searchBox.value.trim()) {
      suggestions.style.display='none';
      clearSelection({push:true});
      return;
    }

    const first = suggestions.querySelector('.suggestItem');
    if (first) {
      const code = first.dataset.code;
      const st = findStock(code);
      suggestions.style.display='none';
      applySelection(st);
      return;
    }

    const q = norm(searchBox.value||'');
    if (q) {
      const st = STOCKS.find(s => s.code.startsWith(q) || norm(s.name).includes(q) || norm(s.reading).startsWith(q));
      if (st) {
        suggestions.style.display='none';
        applySelection(st);
      } else {
        noResult.style.display='block';
      }
    }
  }
});

// サジェストクリック
document.addEventListener('click', (e)=>{
  if(e.target.closest('#suggestList')){
    const item = e.target.closest('.suggestItem'); if(!item) return;
    const code = item.dataset.code;
    const st = findStock(code);
    suggestions.style.display='none';
    applySelection(st);
  } else if(!e.target.closest('.searchWrap')){
    suggestions.style.display='none';
  }
});

/* ========= 起動 ========= */
(async function init(){
  try{
    await loadJSON();

    // 初期選択：URLの ?q=XXXX がある時だけ復元（localStorageは使わない）
    const urlCode = getQueryCode();
    if (urlCode) {
      const st = findStock(urlCode) || STOCKS.find(s => s.code.startsWith(urlCode));
      if (st) {
        history.replaceState({ q: st.code }, '', location.href);
        searchBox.value = `${st.code} ${st.name}`.trim();
        renderStock(st);
      } else {
        clearSelection({ push: false });
      }
    } else {
      const last = restoreLastCode();
      if (last) searchBox.value = last;
      clearSelection({ push: false });
    }

    // 戻る/進むで q が変わったら復元
    window.addEventListener('popstate', (ev) => {
      const stateQ = ev.state && typeof ev.state.q === 'string' ? ev.state.q : null;
      const q = stateQ !== null ? stateQ : getQueryCode();
      if(!q){
        clearSelection({push:false});
        return;
      }
      const st = findStock(q) || STOCKS.find(s=>s.code.startsWith(q));
      if(st){
        setQueryCode(st.code, 'replace');
        saveLastCode(st.code);
        searchBox.value = `${st.code} ${st.name}`.trim();
        renderStock(st);
      }else{
        clearSelection({push:false});
      }
    });

  }catch(e){
    noResult.style.display='block';
    noResult.textContent = 'JSON 読み込み失敗: '+e.message;
  }
})();
</script>
</body>
</html>
